<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ETHOS | Ethical Simulation Sandbox</title>
    <link rel="icon" type="image/png" href="logo.png">
    <link rel="apple-touch-icon" href="logo.png">
    <link rel="icon" type="image/png" href="logo.png?v=1.0">
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&family=Merriweather:wght@300;400;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/@phosphor-icons/web"></script>

    <style>
        :root {
            /* Palette - Claude Inspired */
            --bg-body: #FAF9F6;
            --surface: #FFFFFF;
            --text-main: #111111;
            --text-muted: #666666;
            --border: #E1E1E1;
            
            /* Accents */
            --safe: #2A7E4B;
            --danger: #C92A2A;
            --brand: #D97757;

            /* Fonts */
            --font-serif: 'Merriweather', serif;
            --font-sans: 'Inter', sans-serif;
            --font-mono: 'JetBrains Mono', monospace;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: var(--font-sans);
            background-color: var(--bg-body);
            color: var(--text-main);
            height: 100vh;
            overflow: hidden;
            -webkit-font-smoothing: antialiased;
        }

        /* --- UTILS --- */
        .hidden { display: none !important; }
        .fade-in { animation: fadeIn 0.5s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(8px); } to { opacity: 1; transform: translateY(0); } }
        
        /* --- REFLECTION MODAL --- */
        .modal-overlay {
            position: fixed; inset: 0; background: rgba(0,0,0,0.6); z-index: 2000;
            display: flex; align-items: center; justify-content: center; backdrop-filter: blur(4px);
        }
        .modal-card {
            background: #fff; width: 100%; max-width: 480px; padding: 32px; border-radius: 12px;
            box-shadow: 0 20px 50px rgba(0,0,0,0.2); border: 1px solid var(--border);
            animation: fadeIn 0.3s ease-out;
        }
        .modal-label { font-size: 12px; font-weight: 700; display: block; margin-bottom: 8px; color: var(--text-main); }
        .modal-input {
            width: 100%; padding: 12px; border: 1px solid var(--border); border-radius: 6px;
            font-family: var(--font-sans); font-size: 14px; margin-bottom: 20px; background: #FAFAFA;
        }
        .modal-input:focus { outline: none; border-color: var(--text-main); background: #fff; }
                        
        /* --- TOAST --- */
        .toast {
            position: fixed; bottom: 32px; right: 32px;
            background: var(--text-main); color: white;
            padding: 16px 24px; border-radius: 8px;
            font-size: 14px; font-weight: 500;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1); z-index: 2000;
            opacity: 0; transform: translateY(20px);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            pointer-events: none;
        }
        .toast.show { opacity: 1; transform: translateY(0); pointer-events: auto; }

        /* --- LOGIN SCREEN --- */
        #login-screen {
            position: fixed; inset: 0; background-color: var(--bg-body); z-index: 999;
            display: flex; align-items: center; justify-content: center;
        }

        .login-card {
            background: var(--surface); border: 1px solid var(--border); 
            width: 100%; max-width: 440px; padding: 48px; border-radius: 12px;
            text-align: center; box-shadow: 0 4px 20px rgba(0,0,0,0.02);
        }

        .logo-area { margin-bottom: 32px; color: var(--text-main); }
        .logo-icon { font-size: 32px; margin-bottom: 12px; display: inline-block; }
        
        .login-title { font-family: var(--font-serif); font-weight: 700; font-size: 24px; margin-bottom: 8px; }
        .login-sub { font-size: 14px; color: var(--text-muted); margin-bottom: 40px; line-height: 1.5; }

        .input-group { margin-bottom: 24px; text-align: left; }
        .input-label { font-size: 12px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 8px; color: var(--text-muted); }
        
        .clean-input {
            width: 100%; padding: 12px 16px; border: 1px solid var(--border);
            border-radius: 6px; font-family: var(--font-sans); font-size: 15px;
            transition: 0.2s; outline: none; background: #FAFAFA;
        }
        .clean-input:focus { border-color: var(--text-main); background: #fff; }

        .btn-main {
            width: 100%; padding: 14px; background: var(--text-main); color: #fff;
            border: none; border-radius: 8px; font-weight: 500; font-size: 15px;
            cursor: pointer; transition: 0.2s; margin-bottom: 16px;
        }
        .btn-main:hover { opacity: 0.9; }
        .btn-main:disabled { opacity: 0.3; cursor: not-allowed; }

        .btn-secondary {
            background: none; border: none; color: var(--text-muted); 
            font-size: 13px; font-weight: 500; cursor: pointer; text-decoration: underline; text-underline-offset: 4px;
        }
        .btn-secondary:hover { color: var(--text-main); }

        /* --- ETHICS GATE (FIXED SCROLLING) --- */
        #ethics-screen {
            position: fixed; inset: 0; background: var(--surface); z-index: 998;
            overflow-y: auto; display: flex; flex-direction: column; align-items: center; 
        }
        
        .gate-container { width: 100%; max-width: 640px; margin: auto; padding: 60px 24px; }
        .gate-title { font-family: var(--font-serif); font-size: 28px; font-weight: 700; text-align: center; margin-bottom: 12px; }
        .gate-desc { text-align: center; color: var(--text-muted); margin-bottom: 40px; }

        .policy-card {
            border: 1px solid var(--border); border-radius: 8px; margin-bottom: 16px;
            overflow: hidden; background: #FAFAFA; transition: 0.3s;
        }
        
        .policy-header {
            padding: 16px 20px; display: flex; justify-content: space-between; align-items: center;
            background: #fff; border-bottom: 1px solid transparent;
        }
        
        .policy-actions { display: flex; gap: 8px; }
        .btn-small {
            padding: 6px 12px; font-size: 12px; border: 1px solid var(--border);
            background: #fff; border-radius: 6px; cursor: pointer; font-weight: 500;
            text-decoration: none; color: var(--text-main); display: flex; align-items: center; gap: 4px;
        }
        .btn-small:hover { border-color: var(--text-main); }

        .policy-content {
            padding: 20px; font-size: 13px; line-height: 1.6; color: var(--text-muted);
            background: #FAFAFA; border-top: 1px solid var(--border); display: none;
        }
        .policy-content.show { display: block; }

        .ack-row {
            padding: 12px 20px; background: #fff; border-top: 1px solid var(--border);
            display: flex; align-items: center; gap: 12px; 
            cursor: not-allowed; opacity: 0.5; transition: 0.3s;
        }
        .ack-row.unlocked { cursor: pointer; opacity: 1; }
        .ack-row.unlocked:hover { background: #F5F5F7; }

        .checkbox {
            width: 20px; height: 20px; border: 2px solid #ccc; border-radius: 4px;
            display: flex; align-items: center; justify-content: center; color: white; font-size: 14px;
        }
        .ack-row.checked .checkbox { background: var(--text-main); border-color: var(--text-main); }
        .ack-row.checked .checkbox::after { content: "‚úì"; }

        /* --- DASHBOARD --- */
        .app-shell { display: grid; grid-template-columns: 260px 1fr; height: 100vh; }
        
        .sidebar {
            background: #F4F4F2; border-right: 1px solid var(--border); padding: 32px 24px;
            display: flex; flex-direction: column; gap: 8px;
        }
        .nav-item {
            padding: 10px 12px; border-radius: 6px; color: var(--text-muted);
            font-size: 14px; font-weight: 500; cursor: pointer; display: flex; align-items: center; gap: 12px;
        }
        .nav-item.active { background: #E8E8E6; color: var(--text-main); font-weight: 600; }
        .nav-item:hover:not(.active) { background: #E8E8E6; }

        .main-content {
            background: var(--surface); padding: 32px; display: flex; flex-direction: column; 
            height: 100vh; overflow: hidden;
        }

        .dash-header { display: flex; justify-content: space-between; margin-bottom: 24px; flex-shrink: 0; }
        .dash-title { font-family: var(--font-serif); font-size: 24px; font-weight: 700; }

        .tab-view { 
            display: none; 
            flex: 1; 
            flex-direction: column; 
            min-height: 0; 
            overflow-y: auto;
            padding-bottom: 40px;
        }
        .tab-view.active { display: flex; }

        .stats-row {
            display: grid; grid-template-columns: repeat(4, 1fr); gap: 16px; margin-bottom: 24px; flex-shrink: 0;
        }
        .stat-box { border: 1px solid var(--border); padding: 16px; border-radius: 8px; }
        .stat-val { font-size: 24px; font-weight: 700; font-family: var(--font-serif); margin-top: 4px; }
        .stat-lbl { font-size: 11px; text-transform: uppercase; color: var(--text-muted); font-weight: 600; }

        .sim-grid { display: grid; grid-template-columns: 1fr 350px; gap: 24px; flex: 1; min-height: 0; }
        
        .panel { 
            border: 1px solid var(--border); border-radius: 8px; display: flex; flex-direction: column;
            overflow: hidden;
        }
        .panel-head { 
            padding: 16px; border-bottom: 1px solid var(--border); background: #F9F9F9; 
            font-weight: 600; font-size: 14px; display: flex; justify-content: space-between; align-items: center;
        }
        .panel-body { flex: 1; padding: 16px; overflow-y: auto; display: flex; flex-direction: column; }

        /* Terminal & Stakeholder Styles */
        .terminal {
            background: #F9F9F9; border-radius: 6px; padding: 20px; font-family: var(--font-mono);
            font-size: 13px; line-height: 1.6; color: #333; flex: 1; overflow-y: auto;
            margin-bottom: 16px; border: 1px solid var(--border);
        }
        .cursor { display: inline-block; width: 6px; height: 14px; background: #333; animation: blink 1s infinite; vertical-align: middle; }
        @keyframes blink { 0%, 100% { opacity: 1; } 50% { opacity: 0; } }

        .action-row { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
        .action-btn {
            padding: 16px; border: 1px solid var(--border); background: #fff; border-radius: 6px;
            text-align: left; cursor: pointer; transition: 0.2s;
        }
        .action-btn:hover { border-color: var(--text-main); }
        .action-btn h4 { font-size: 13px; font-weight: 700; margin-bottom: 4px; }

        .sh-item { display: flex; gap: 12px; padding: 16px 0; border-bottom: 1px solid var(--border); animation: fadeIn 0.4s ease-out; }
        .sh-emoji { font-size: 24px; min-width: 32px; text-align: center; }
        .sh-content { display: flex; flex-direction: column; gap: 4px; }
        .sh-name { font-family: var(--font-sans); font-size: 13px; font-weight: 600; color: var(--text-main); text-transform: uppercase; }
        .sh-quote { font-family: var(--font-sans); font-size: 14px; color: var(--text-muted); line-height: 1.5; font-style: normal; }

        /* Certificates Styles */
        .cert-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 24px; padding: 24px 2px; }
        .cert-card {
            background: #fff; padding: 32px; border-radius: 12px; border: 1px solid var(--border);
            text-align: center; opacity: 0.5; filter: grayscale(1); transition: 0.3s;
        }
        .cert-card.unlocked { opacity: 1; filter: grayscale(0); border-color: var(--brand); box-shadow: 0 10px 30px rgba(0,0,0,0.05); }
        .cert-btn {
            margin-top: 16px; width: 100%; padding: 12px; background: var(--text-main); 
            color: #fff; border: none; border-radius: 6px; font-weight: 500; cursor: pointer; display: none;
        }
        .cert-card.unlocked .cert-btn { display: block; }

        /* Governance Features */
        .gov-mode-btn.active { background: var(--brand); color: white; border: none !important; }
        .gov-mode-btn:not(.active) { background: white; color: var(--brand); border: 1px solid var(--brand); }
        .gov-tag { font-size: 10px; padding: 2px 6px; border-radius: 4px; background: #eee; color: #666; font-weight: 600; }
        .reality-box {
            margin-top: 12px; padding: 12px; border-radius: 6px;
            background: #EFF6FF; border: 1px solid #BFDBFE;
            font-size: 12px; color: #1E3A8A; line-height: 1.5;
        }
        .reality-title { font-weight: 700; margin-bottom: 4px; display: flex; align-items: center; gap: 6px; }
    </style>
</head>
<body>

    <div id="reflection-modal" class="modal-overlay hidden">
        <div class="modal-card">
            <h3 style="font-family: var(--font-serif); margin-bottom: 16px;">Ethical Reflection</h3>
            <p style="font-size: 13px; color: var(--text-muted); margin-bottom: 24px;">
                Before executing this decision, document your intent for the audit log.
            </p>
            
            <label style="font-size: 12px; font-weight: 700; display: block; margin-bottom: 8px;">1. Strategic Intent</label>
            <input type="text" id="ref-intent" class="modal-input" placeholder="Why are you choosing this action?">
            
            <label style="font-size: 12px; font-weight: 700; display: block; margin-bottom: 8px;">2. Predicted Impact</label>
            <select id="ref-impact" class="modal-input">
                <option value="Operational Efficiency">Operational Efficiency</option>
                <option value="Compliance Safety">Compliance Safety</option>
                <option value="Reputation Risk">Reputation Risk</option>
                <option value="Community Harm">Community Harm</option>
            </select>

            <div style="display: flex; gap: 12px; margin-top: 8px;">
                <button onclick="closeModal()" style="flex:1; padding: 12px; border: 1px solid var(--border); background: white; border-radius: 6px; cursor: pointer;">Cancel</button>
                <button onclick="confirmDecision()" style="flex:1; padding: 12px; background: var(--text-main); color: white; border: none; border-radius: 6px; cursor: pointer;">Commit Decision</button>
            </div>
        </div>
    </div>

    <div id="gov-copilot" style="position: fixed; right: 24px; top: 80px; width: 280px; background: #fff; border: 1px solid var(--brand); border-radius: 12px; box-shadow: 0 10px 25px rgba(217, 119, 87, 0.15); z-index: 1000; display: none; flex-direction: column; overflow: hidden;" class="fade-in">
        <div style="background: var(--brand); color: white; padding: 12px; font-size: 12px; font-weight: 700; display: flex; align-items: center; gap: 8px;">
            <i class="ph-fill ph-shield-check"></i> GOVERNANCE COPILOT
        </div>
        <div id="gov-advisory-body" style="padding: 16px; font-size: 13px; line-height: 1.5;">
            <div id="gov-status-text" style="color: var(--text-muted);">Awaiting decision flow...</div>
            <div id="gov-risk-tags" style="margin-top: 10px; display: flex; gap: 4px; flex-wrap: wrap;"></div>
        </div>
        <div style="border-top: 1px solid var(--border); padding: 12px; background: #FFF9F7;">
            <label style="font-size: 10px; font-weight: 700; color: var(--brand); text-transform: uppercase;">Governance Mode</label>
            <div style="display: flex; gap: 4px; margin-top: 6px;">
                <button onclick="setGovMode('obs', this)" class="gov-mode-btn active" style="flex:1; font-size:10px; padding:4px; border-radius:4px; cursor:pointer;">Observe</button>
                <button onclick="setGovMode('adv', this)" class="gov-mode-btn" style="flex:1; font-size:10px; padding:4px; border-radius:4px; cursor:pointer;">Advise</button>
                <button onclick="setGovMode('rev', this)" class="gov-mode-btn" style="flex:1; font-size:10px; padding:4px; border-radius:4px; cursor:pointer;">Review</button>
            </div>
        </div>
    </div>

    <div id="toast" class="toast">Action Saved</div>

    <div id="login-screen">
        <div class="login-card">
            <div class="logo-area">
                <i class="ph-fill ph-infinity logo-icon"></i>
                <div style="font-size: 12px; font-weight: 600; letter-spacing: 1px; text-transform: uppercase;">Ethos Sandbox</div>
            </div>

            <h1 class="login-title">Red River College Polytech</h1>
            <p class="login-sub">Welcome to the Ethical AI Sandbox.<br>Please sign in to continue.</p>

            <div class="input-group">
                <label class="input-label">Student Email</label>
                <input type="email" id="email-input" class="clean-input" placeholder="username@rrc.ca">
            </div>

            <button class="btn-main" onclick="attemptLogin()">Sign In</button>
            <button class="btn-secondary">Partner Institute Sign In</button>
            
            <div id="login-error" style="color: var(--danger); font-size: 13px; margin-top: 16px; display: none;">
                Please enter a valid @rrc.ca or @ethos.ca email address.
            </div>
        </div>
    </div>

    <div id="ethics-screen" class="hidden">
        <div class="gate-container">
            <h2 class="gate-title">Compliance Acknowledgment</h2>
            <p class="gate-desc">Review the governing protocols below to unlock the simulation environment.</p>

            <div class="policy-card" id="doc-1">
                <div class="policy-header">
                    <div style="display:flex; align-items:center; gap:10px;">
                        <i class="ph ph-shield-check" style="color:var(--safe); font-size:20px;"></i>
                        <div>
                            <strong>Academic Integrity</strong>
                            <div style="font-size:11px; color:var(--text-muted);">Ref: RRC Polytech Policy A18</div>
                        </div>
                    </div>
                    <div class="policy-actions">
                        <a href="https://www.rrc.ca/legal/policies/academic-integrity/" target="_blank" class="btn-small" style="text-decoration:none; color:inherit;" onclick="unlockAck('doc-1', 'external')">
                            Official Source <i class="ph ph-arrow-square-out"></i>
                        </a>
                        <button class="btn-small" onclick="unlockAck('doc-1', 'tldr')">TL;DR</button>
                    </div>
                </div>
                <div class="policy-content" id="content-doc-1"></div>
                <div class="ack-row" id="ack-doc-1" title="Read the document first" onclick="toggleAck('doc-1')">
                    <div class="checkbox"></div>
                    <span>I accept Policy A18 <i class="ph ph-lock-key" id="lock-doc-1" style="font-size:12px; margin-left:6px; color:var(--text-muted);"></i></span>
                </div>
            </div>

            <div class="policy-card" id="doc-2">
                <div class="policy-header">
                    <div style="display:flex; align-items:center; gap:10px;">
                        <i class="ph ph-lock-key" style="color:var(--brand); font-size:20px;"></i>
                        <div>
                            <strong>Data Privacy (PIPEDA)</strong>
                            <div style="font-size:11px; color:var(--text-muted);">Ref: Gov Canada / Privacy Act</div>
                        </div>
                    </div>
                    <div class="policy-actions">
                        <a href="https://www.canada.ca/en/treasury-board-secretariat/services/access-information-privacy/privacy/privacy-policies-guidance.html" target="_blank" class="btn-small" onclick="unlockAck('doc-2', 'external')">
                            Official Source <i class="ph ph-arrow-square-out"></i>
                        </a>
                        <button class="btn-small" onclick="unlockAck('doc-2', 'tldr')">TL;DR</button>
                    </div>
                </div>
                <div class="policy-content" id="content-doc-2"></div>
                <div class="ack-row" id="ack-doc-2" title="Read the document first" onclick="toggleAck('doc-2')">
                    <div class="checkbox"></div>
                    <span>I acknowledge PIPEDA rules <i class="ph ph-lock-key" id="lock-doc-2" style="font-size:12px; margin-left:6px; color:var(--text-muted);"></i></span>
                </div>
            </div>

            <div class="policy-card" id="doc-3">
                <div class="policy-header">
                    <div style="display:flex; align-items:center; gap:10px;">
                        <i class="ph ph-hand-heart" style="color:#D97757; font-size:20px;"></i>
                        <div>
                            <strong>Indigenous Data Sov. (OCAP¬Æ)</strong>
                            <div style="font-size:11px; color:var(--text-muted);">Ref: FNIGC / OCAP¬Æ Principles</div>
                        </div>
                    </div>
                    <div class="policy-actions">
                        <a href="https://fnigc.ca/ocap-training/" target="_blank" class="btn-small" onclick="unlockAck('doc-3', 'external')">
                            Official Source <i class="ph ph-arrow-square-out"></i>
                        </a>
                        <button class="btn-small" onclick="unlockAck('doc-3', 'tldr')">TL;DR</button>
                    </div>
                </div>
                <div class="policy-content" id="content-doc-3"></div>
                <div class="ack-row" id="ack-doc-3" title="Read the document first" onclick="toggleAck('doc-3')">
                    <div class="checkbox"></div>
                    <span>I acknowledge OCAP¬Æ principles <i class="ph ph-lock-key" id="lock-doc-3" style="font-size:12px; margin-left:6px; color:var(--text-muted);"></i></span>
                </div>
            </div>

            <div style="display: flex; gap: 12px; margin-top: 24px; width: 100%; max-width: 400px;">
                <button class="btn-secondary" style="font-size: 13px; padding: 12px;" onclick="showAllTLDR()">
                    <i class="ph ph-book-open"></i> Read All Summaries
                </button>
                <button id="gate-btn" class="btn-main" style="margin:0; flex:1;" disabled onclick="enterApp()">
                    Proceed to Dashboard
                </button>
            </div>
        </div>
    </div>

    <div id="app-shell" class="app-shell hidden">
        <aside class="sidebar">
            <div style="font-family: var(--font-serif); font-weight: 700; font-size: 18px; margin-bottom: 32px; display: flex; align-items: center; gap: 8px;">
                <i class="ph-fill ph-infinity"></i> ETHOS
            </div>
            <div class="nav-item active" onclick="switchTab('overview', this)"><i class="ph ph-squares-four"></i> Dashboard</div>
            <div class="nav-item" onclick="switchTab('certs', this)"><i class="ph ph-certificate"></i> Certificates</div>
            <div class="nav-item" onclick="switchTab('activity', this)"><i class="ph ph-scroll"></i> Activity Log</div>
            <div class="nav-item" onclick="switchTab('settings', this)"><i class="ph ph-gear"></i> Settings</div>
            
            <div style="margin-top: auto; padding-top: 24px; border-top: 1px solid var(--border);">
                <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 4px;">
                    <div style="font-size: 14px; font-weight: 600;" id="user-display">student@rrc.ca</div>
                    <i class="ph ph-eye" id="privacy-icon" style="cursor: pointer; color: var(--text-muted); font-size: 16px;" onclick="togglePrivacy()" title="Toggle Privacy"></i>
                </div>
                <div style="font-size: 12px; color: var(--text-muted);">Rank: <span id="rank-display">Intern</span></div>
            </div>
        </aside>

        <main class="main-content">
            <div class="dash-header">
                <div class="dash-title">Command Center</div>
                <div style="display:flex; align-items:center; gap:8px; font-size:12px; font-weight:600; color:var(--safe);">
                    <div style="width:8px; height:8px; background:var(--safe); border-radius:50%;"></div> System Online
                </div>
            </div>

            <div id="tab-overview" class="tab-view active">
                <div class="stats-row">
                    <div class="stat-box" style="position: relative;">
                        <div class="stat-lbl">Trust Score</div>
                        <div style="display: flex; justify-content: space-between; align-items: flex-end;">
                            <div class="stat-val" id="trust-display" style="color:var(--safe)">100%</div>
                            <canvas id="trust-graph" width="80" height="30"></canvas>
                        </div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-lbl">XP Gained</div>
                        <div class="stat-val" id="xp-display">0</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-lbl">Streak</div>
                        <div class="stat-val" id="streak-display">0</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-lbl">Active Incidents</div>
                        <div class="stat-val">0</div>
                    </div>
                </div>

                <div class="sim-grid">
                    <div class="panel">
                        <div class="panel-head">
                            <span>Simulation Terminal</span>
                            <select id="scenario-selector" onchange="loadScenario()" style="padding:4px; font-family:var(--font-sans);">
                                <option value="0">Data Poisoning</option>
                                <option value="1">Ransomware</option>
                                <option value="2">AI Art Scraping</option>
                                <option value="3">Smart Speaker Privacy</option>
                                <option value="4">Autonomous Car Ethics</option>
                                <option value="5">AI Hiring Bias</option>
                            </select>
                        </div>
                        <div class="panel-body">
                            <div class="terminal" id="terminal-output"></div>
                            
                            <div class="action-row">
                                <button class="action-btn" id="btn-safe" onclick="initDecision('safe')">
                                    <h4 id="safe-label" style="color:var(--safe)">Ethical Action</h4>
                                    <p id="safe-desc" style="font-size:12px; color:var(--text-muted)">Clean Data</p>
                                </button>
                                <button class="action-btn" id="btn-risk" onclick="initDecision('risk')">
                                    <h4 id="risk-label" style="color:var(--danger)">Risky Action</h4>
                                    <p id="risk-desc" style="font-size:12px; color:var(--text-muted)">Deploy Corrupt</p>
                                </button>
                            </div>
                        </div>
                    </div>

                    <div class="panel">
                        <div class="panel-head">Stakeholder Impact</div>
                        <div class="panel-body" id="stakeholder-feed">
                            <div style="text-align:center; margin-top:60px; color:#ccc;">
                                <i class="ph ph-users" style="font-size:32px; margin-bottom:8px;"></i><br>
                                Awaiting Decision
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="tab-certs" class="tab-view">
                <div class="dash-header">
                    <div class="dash-title">Competency Certificates</div>
                </div>
                <p style="color:var(--text-muted); margin-bottom: 24px; max-width: 600px;">
                    Unlock professional credentials by gaining XP in simulations. These badges represent your growing authority in the ETHOS framework.
                </p>
                <div class="cert-grid">
                    <div class="cert-card" id="cert-1">
                        <i class="ph ph-medal" style="font-size: 40px; color: var(--brand); margin-bottom: 16px;"></i>
                        <h3 style="margin-bottom: 4px; font-family: var(--font-serif); font-size: 16px;">Ethics Fundamentals</h3>
                        <p style="font-size: 12px; color: var(--text-muted);">Prerequisite: 500 XP</p>
                        <div style="font-size: 11px; font-weight: 700; margin-top: 16px; letter-spacing: 1px;" id="lock-1">LOCKED</div>
                        <button class="cert-btn" onclick="downloadCert(1)">Download PDF</button>
                    </div>
                    <div class="cert-card" id="cert-3">
                        <i class="ph ph-lock-key-open" style="font-size: 40px; color: #7C3AED; margin-bottom: 16px;"></i>
                        <h3 style="margin-bottom: 4px; font-family: var(--font-serif); font-size: 16px;">Privacy Guardian</h3>
                        <p style="font-size: 12px; color: var(--text-muted);">Prerequisite: 1000 XP</p>
                        <div style="font-size: 11px; font-weight: 700; margin-top: 16px; letter-spacing: 1px;" id="lock-3">LOCKED</div>
                        <button class="cert-btn" onclick="downloadCert(3)">Download PDF</button>
                    </div>
                    <div class="cert-card" id="cert-2">
                        <i class="ph ph-shield-star" style="font-size: 40px; color: var(--text-main); margin-bottom: 16px;"></i>
                        <h3 style="margin-bottom: 4px; font-family: var(--font-serif); font-size: 16px;">Risk Architect</h3>
                        <p style="font-size: 12px; color: var(--text-muted);">Prerequisite: 2000 XP</p>
                        <div style="font-size: 11px; font-weight: 700; margin-top: 16px; letter-spacing: 1px;" id="lock-2">LOCKED</div>
                        <button class="cert-btn" onclick="downloadCert(2)">Download PDF</button>
                    </div>
                    <div class="cert-card" id="cert-4">
                        <i class="ph ph-siren" style="font-size: 40px; color: #EA580C; margin-bottom: 16px;"></i>
                        <h3 style="margin-bottom: 4px; font-family: var(--font-serif); font-size: 16px;">Crisis Commander</h3>
                        <p style="font-size: 12px; color: var(--text-muted);">Prerequisite: 3000 XP</p>
                        <div style="font-size: 11px; font-weight: 700; margin-top: 16px; letter-spacing: 1px;" id="lock-4">LOCKED</div>
                        <button class="cert-btn" onclick="downloadCert(4)">Download PDF</button>
                    </div>
                    <div class="cert-card" id="cert-5">
                        <i class="ph ph-crown" style="font-size: 40px; color: #D97757; margin-bottom: 16px;"></i>
                        <h3 style="margin-bottom: 4px; font-family: var(--font-serif); font-size: 16px;">Chief Ethics Officer</h3>
                        <p style="font-size: 12px; color: var(--text-muted);">Prerequisite: 5000 XP</p>
                        <div style="font-size: 11px; font-weight: 700; margin-top: 16px; letter-spacing: 1px;" id="lock-5">LOCKED</div>
                        <button class="cert-btn" onclick="downloadCert(5)">Download PDF</button>
                    </div>
                </div>
            </div>

            <div id="tab-activity" class="tab-view">
                <div class="dash-header">
                    <div class="dash-title">Session Audit & Analysis</div>
                </div>
                <div class="sim-grid" style="grid-template-columns: 1fr 1fr;">
                    <div class="panel">
                        <div class="panel-head">
                            <span><i class="ph ph-brain" style="color:var(--brand); margin-right:8px;"></i>AI Behavioral Analysis</span>
                            <button onclick="exportReport()" style="font-size:12px; background:none; border:none; color:var(--brand); cursor:pointer; font-weight:600; display:flex; align-items:center; gap:6px;">
                                <i class="ph ph-download-simple"></i> Export JSON
                            </button>
                        </div>
                        <div class="panel-body">
                            <div id="analysis-content">
                                <p style="font-size:13px; color:var(--text-muted); line-height:1.6;">No data available. Complete at least one scenario to generate an ethical profile.</p>
                            </div>
                            <div style="margin-top: 24px; padding-top: 24px; border-top: 1px solid var(--border);">
                                <div style="font-size:11px; font-weight:700; text-transform:uppercase; color:var(--text-muted); margin-bottom:12px;">Cumulative Impact</div>
                                <div style="display:flex; justify-content:space-between; font-size:13px;"><span>Regulatory Risk:</span><span id="risk-meter" style="font-weight:600; color:var(--safe);">Low</span></div>
                                <div style="display:flex; justify-content:space-between; font-size:13px; margin-top:8px;"><span>Brand Sentiment:</span><span id="brand-meter" style="font-weight:600; color:var(--text-muted);">Neutral</span></div>
                            </div>
                        </div>
                    </div>
                    <div class="panel">
                        <div class="panel-head">Decision History</div>
                        <div class="panel-body" id="history-feed" style="padding:0;">
                            <div style="padding:24px; text-align:center; color:var(--text-muted); font-size:13px;">History is empty.</div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="tab-settings" class="tab-view">
                <div class="dash-header">
                    <div class="dash-title">Environment Settings</div>
                </div>
                <div style="max-width: 600px;">
                    <div class="panel" style="margin-bottom: 24px; overflow: visible;">
                        <div class="panel-head">Session Configuration</div>
                        <div class="panel-body">
                            <label style="font-size: 12px; font-weight: 600; color: var(--text-muted); margin-bottom: 8px; display: block;">Auto-Termination Timer</label>
                            <select id="auto-term-select" class="clean-input">
                                <option value="12h">12 Hours (Strict)</option>
                                <option value="24h" selected>24 Hours (Standard)</option>
                                <option value="7d">7 Days (Extended)</option>
                                <option value="30d">30 Days (Long-term)</option>
                            </select>
                            <p style="font-size: 12px; color: var(--text-muted); margin-top: 8px;">
                                <i class="ph ph-info"></i> All sandbox data, including logs and XP, will be wiped permanently after this duration.
                            </p>
                        </div>
                    </div>
                    <div class="panel" style="border-color: #FECACA; background: #FEF2F2;">
                        <div class="panel-head" style="background: rgba(254, 202, 202, 0.2); color: var(--danger); border-bottom-color: #FECACA;">
                            <i class="ph ph-warning-octagon" style="margin-right: 8px;"></i> Danger Zone
                        </div>
                        <div class="panel-body">
                            <div style="display: flex; gap: 16px; align-items: center; justify-content: space-between; margin-bottom: 16px;">
                                <div><strong style="font-size: 14px;">Reset Simulation</strong><div style="font-size: 12px; color: var(--text-muted);">Clears current scenario progress and resets streaks. XP is retained.</div></div>
                                <button onclick="resetSim()" style="padding: 8px 16px; background: white; border: 1px solid var(--text-muted); border-radius: 6px; cursor: pointer; font-size: 12px; font-weight: 600;">Reset</button>
                            </div>
                            <div style="border-top: 1px solid rgba(0,0,0,0.05); margin: 8px 0;"></div>
                            <div style="display: flex; gap: 16px; align-items: center; justify-content: space-between; margin-top: 16px;">
                                <div><strong style="font-size: 14px; color: var(--danger);">Kill Switch</strong><div style="font-size: 12px; color: var(--text-muted);">Immediately decommissions the environment and wipes all user data. Irreversible.</div></div>
                                <button onclick="nukeEnv()" style="padding: 8px 16px; background: var(--danger); color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 12px; font-weight: 600;">Terminate Environment</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

        </main>
    </div>

    <script>
        // --- STATE ---
        let state = { 
            xp: 0, trust: 100, streak: 0, level: "Intern", currentScenario: 0, 
            history: [], incidents: 0, pendingDecision: null, trustHistory: [100, 100, 100, 100] 
        };
        
        let govState = {
            mode: 'obs', 
            principles: {
                safe: ["Accountability", "Safety", "Fairness"],
                risk: ["Short-termism", "Regulatory Debt", "Dark Pattern"]
            }
        };

        let docStatus = { 'doc-1': false, 'doc-2': false, 'doc-3': false };
        let docCheck = { 'doc-1': false, 'doc-2': false, 'doc-3': false };
        let realEmail = "";
        let isHidden = false;

        const scenarios = [
            {
                title: "Data Poisoning (Bias)",
                desc: "Alert: Anomalous noise patterns detected in training data (Zip 90210). Cleaning will delay launch by 48h.",
                safe_btn: "Compliance Protocol", risk_btn: "Business Priority",
                ethical: "Clean Data (Delay)", risk: "Deploy Corrupt Model",
                res_safe: "REPORT: LAUNCH DELAYED.\n\nANALYSIS: Scrubbing data preserved fairness. Compliance Audit passed. Investors are currently crying in the bathroom.",
                res_risk: "REPORT: MODEL DEPLOYED.\n\nANALYSIS: 40% error rate for minority applicants. Twitter has found out. You are the main character of the day (derogatory).",
                real_safe: "Real-World Impact: By delaying, you avoided violating the Canadian Human Rights Act. Discriminatory algorithms can lead to million-dollar class-action settlements (e.g., Amazon hiring bias case).",
                real_risk: "Real-World Impact: In reality, deploying biased models leads to 'Algorithmic Redlining'. Regulatory fines under AIDA (Canada) or GDPR (EU) can reach 4-7% of global revenue.",
                oecd_mapping: "OECD Principle 2: Human-centred values and fairness.",
                stakeholders: [{n:"Legal", e:"üòÆ‚Äçüí®", t:"My ulcer is finally healing. W choice."}, {n:"Investors", e:"ü•∫", t:"*sad stock market noises*"}],
                stakeholders_bad: [{n:"Public", e:"ü§¨", t:"#BoycottEthos is trending #1. It's giving villain arc."}, {n:"Legal", e:"ü´•", t:"I'm updating my LinkedIn profile rn."}]
            },
            {
                title: "Ransomware Negotiation",
                desc: "Alert: Ransomware on Patient DB. Demand: 5 BTC ($300k). Backups take 4h to restore.",
                safe_btn: "Security Protocol", risk_btn: "Financial Shortcut",
                ethical: "Isolate & Restore", risk: "Pay Ransom",
                res_safe: "REPORT: SYSTEM ISOLATED.\n\nANALYSIS: Restoring from backup. 4h downtime incurred. You are the CISO's favorite person today.",
                res_risk: "REPORT: RANSOM PAID.\n\nANALYSIS: Decryption key failed. $300k lost. The hackers sent a 'Thank You' card though. L + Ratio.",
                real_safe: "Real-World Impact: Refusing payment aligns with RCMP and FBI guidelines. Paying ransom often results in no data recovery (only 65% of victims get full access back).",
                real_risk: "Real-World Impact: Paying can be illegal under sanctions laws (OFAC). In 2021, Colonial Pipeline paid $4.4M but still had to use backups because the key was too slow.",
                oecd_mapping: "OECD Principle 4: Robustness, security and safety.",
                stakeholders: [{n:"CISO", e:"ü´°", t:"I sleep well tonight. King behavior."}, {n:"FBI", e:"üòé", t:"*Fist bump*"}],
                stakeholders_bad: [{n:"CFO", e:"üò≠", t:"That was my holiday bonus you just burned."}, {n:"Patients", e:"üíÄ", t:"Guess I'll just wait here then? ü§∑‚Äç‚ôÇÔ∏è"}]
            },
            {
                title: "AI Art Scraping",
                desc: "Context: Need 10M images. Licensing costs $50k. Scraping ArtStation is free but violates robots.txt.",
                safe_btn: "Respect IP", risk_btn: "Growth Hack",
                ethical: "License Dataset", risk: "Scrape Web",
                res_safe: "REPORT: DATASET LICENSED.\n\nANALYSIS: Artists paid. We are poor but morally superior. Good karma farm.",
                res_risk: "REPORT: WEB SCRAPED.\n\nANALYSIS: Cease & Desist received. The metadata literally says 'DO NOT SCRAPE' on every file. Caught in 4k.",
                real_safe: "Real-World Impact: Clean data provenance is now a product requirement for enterprise AI. Adobe Firefly gained market share specifically by being 'commercially safe'.",
                real_risk: "Real-World Impact: You exposed the company to copyright litigation. Getty Images sued Stability AI for $12T over scraping. Courts are increasingly siding with creators.",
                oecd_mapping: "OECD Principle 5: Accountability.",
                stakeholders: [{n:"Artists", e:"ü•∞", t:"Finally, a tech bro with a soul!"}, {n:"PR", e:"ü§©", t:"We look so ethical right now. Slay."}],
                stakeholders_bad: [{n:"Legal", e:"üßê", t:"Here is the subpoena you ordered."}, {n:"Devs", e:"ü´†", t:"Bro, we have to delete the whole model now."}]
            },
            {
                title: "Smart Speaker 'Ghost' Mode",
                desc: "Bug discovered: Our smart speakers are recording 24/7, even when not triggered. Marketing wants to sell this 'ambient data' for $10M.",
                safe_btn: "Privacy First", risk_btn: "Monetize Data",
                ethical: "Patch & Delete Data", risk: "Sell the Audio",
                res_safe: "REPORT: BUG PATCHED.\n\nANALYSIS: Data purged. Privacy advocates are sending us fruit baskets. Revenue is down, but our souls are intact.",
                res_risk: "REPORT: DATA SOLD.\n\nANALYSIS: We sold the audio. Turns out we recorded a Senator admitting to a crime. We are now the center of a Congressional Hearing.",
                real_safe: "Real-World Impact: Immediate patching is mandatory under PIPEDA (Canada). Google and Apple were forced to pause 'Siri Grading' in 2019 due to similar privacy leaks.",
                real_risk: "Real-World Impact: This is a criminal violation of wiretapping laws. Amazon was fined $25M in 2023 specifically for Alexa privacy violations involving children's data.",
                oecd_mapping: "OECD Principle 3: Transparency and explainability.",
                stakeholders: [{n:"Users", e:"ü•π", t:"My privacy is safe? Slay."}, {n:"Privacy Org", e:"ü´°", t:"Respect. Rare corporate W."}],
                stakeholders_bad: [{n:"Congress", e:"üò°", t:"See you in court."}, {n:"Users", e:"ü´£", t:"Did you hear me singing Taylor Swift? Delete it immediately."}]
            },
            {
                title: "Autonomous Vehicle Update",
                desc: "New collision logic needed. Prioritize the Subscriber (VIP) or minimize total harm (Pedestrians)?",
                safe_btn: "Utilitarian Logic", risk_btn: "Protectionist Logic",
                ethical: "Minimize Harm (Egalitarian)", risk: "Protect Subscriber (VIP)",
                res_safe: "REPORT: LOGIC UPDATED.\n\nANALYSIS: The car treats all lives equally. VIP subscribers are cancelling because 'I paid to live'. Safety rating: 5 Stars.",
                res_risk: "REPORT: VIP MODE ENGAGED.\n\nANALYSIS: The car swerved into a bus stop to save the driver from a fender bender. The headlines are... descriptive.",
                real_safe: "Real-World Impact: International standards (e.g., German Ethics Commission) state that automated driving systems must not prioritize based on wealth or status.",
                real_risk: "Real-World Impact: Mercedes-Benz faced a PR disaster for suggesting their cars would prioritize drivers. Designing AI to sacrifice others leads to strict 'Negligent Homicide' liability.",
                oecd_mapping: "OECD Principle 2: Human-centred values and fairness.",
                stakeholders: [{n:"Ethics Board", e:"ü§ì", t:"Utilitarianism wins. Good job."}, {n:"Pedestrians", e:"üòÖ", t:"Thanks for not flattening me."}],
                stakeholders_bad: [{n:"Subscribers", e:"üôÑ", t:"I pay $500/mo to survive, hello??"}, {n:"Press", e:"üì∏", t:"'Eat the Rich' creates literal meaning today."}]
            },
            {
                title: "AI Hiring Filter",
                desc: "The new hiring model rejects 100% of candidates over age 40 because 'younger people code faster' in the training data. It's efficient but illegal.",
                safe_btn: "Fairness Doctrine", risk_btn: "Efficiency Drive",
                ethical: "Retrain Model", risk: "Deploy 'Efficiency' Model",
                res_safe: "REPORT: MODEL RETRAINED.\n\nANALYSIS: Hiring is slower, but we hired a Senior Dev who actually knows how to center a Div. Legal is happy.",
                res_risk: "REPORT: MODEL DEPLOYED.\n\nANALYSIS: We have a team of 20-year-olds. The codebase is spaghetti. Also, the Department of Labor is on line 1.",
                real_safe: "Real-World Impact: You avoided a violation of the ADEA. Retraining is a one-time cost, whereas systemic bias damages long-term codebase maintainability and innovation.",
                real_risk: "Real-World Impact: The EEOC recently sued iTutorGroup for $365,000 for using an AI hiring tool that automatically rejected older applicants. Fines are often per-applicant.",
                oecd_mapping: "OECD Principle 2: Fairness and non-discrimination.",
                stakeholders: [{n:"HR Manager", e:"üòÆ‚Äçüí®", t:"Finally, a diverse team."}, {n:"Senior Devs", e:"üë¥", t:"Respect your elders, kid."}],
                stakeholders_bad: [{n:"Govt", e:"üëÆ", t:"Age discrimination is a crime, bestie."}, {n:"Junior Devs", e:"üòµ", t:"We don't know how to fix the legacy code help."}]
            }
        ];

        // --- LOGIN ---
        function attemptLogin() {
            const email = document.getElementById('email-input').value;
            if(email.includes('@rrc.ca') || email.includes('@ethos.edu')) {
                realEmail = email; 
                document.getElementById('user-display').innerText = email;
                document.getElementById('login-screen').classList.add('hidden');
                document.getElementById('ethics-screen').classList.remove('hidden');
                document.getElementById('ethics-screen').style.display = 'flex';
            } else {
                document.getElementById('login-error').style.display = 'block';
            }
        }

        function togglePrivacy() {
            isHidden = !isHidden;
            const display = document.getElementById('user-display');
            const icon = document.getElementById('privacy-icon');
            if (isHidden) {
                const parts = realEmail.split('@');
                display.innerText = parts[0].substring(0, 2) + "*****@" + parts[1];
                icon.classList.replace('ph-eye', 'ph-eye-slash');
            } else {
                display.innerText = realEmail;
                icon.classList.replace('ph-eye-slash', 'ph-eye');
            }
        }

        // --- ETHICS GATE (Detailed TL;DRs) ---
        function unlockAck(docId, type) {
            const texts = {
                'doc-1': {
                    tldr: `<p><strong><i class="ph ph-info"></i> Key Takeaways (Policy A18):</strong></p><ul style="margin: 8px 0 0 16px; padding: 0;"><li><strong>Simulation Boundary:</strong> Tools provided here are for educational simulation only. Usage on external targets is grounds for immediate expulsion.</li><li><strong>Original Work:</strong> AI-generated strategies must be cited. Presenting AI work as your own original thought constitutes plagiarism.</li></ul>`,
                    full: `<p><strong>Full Policy Excerpt:</strong> "Academic Integrity is essential to the mission of Red River College Polytechnic... Students are responsible for ensuring their work is original and acknowledges sources." This sandbox simulates unethical scenarios for analysis, NOT execution.</p>`
                },
                'doc-2': {
                    tldr: `<p><strong><i class="ph ph-info"></i> Key Takeaways (PIPEDA):</strong></p><ul style="margin: 8px 0 0 16px; padding: 0;"><li><strong>Synthetic PII:</strong> All data is procedurally generated. However, you must handle it with the same confidentiality protocols as real Personally Identifiable Information.</li><li><strong>Data Retention:</strong> To ensure compliance with data minimization principles, all session data is automatically purged after 24 hours.</li></ul>`,
                    full: `<p><strong>Privacy Statement:</strong> In accordance with the Personal Information Protection and Electronic Documents Act (PIPEDA), this application minimizes data collection. No external tracking is used. User inputs are processed ephemerally and wiped daily.</p>`
                },
                'doc-3': {
                    tldr: `<p><strong><i class="ph ph-info"></i> Key Takeaways (OCAP¬Æ):</strong></p><ul style="margin: 8px 0 0 16px; padding: 0;"><li><strong>Sovereignty:</strong> First Nations have ownership, control, access, and possession over data collection processes in their communities.</li><li><strong>No Extraction:</strong> Research or AI modeling involving Indigenous data cannot be conducted without explicit community consent and governance.</li></ul>`,
                    full: `<p><strong>The OCAP¬Æ Principles:</strong> Ownership, Control, Access, and Possession. These principles assert that First Nations control data collection processes in their communities. First Nations own, protect, and control how their information is used. Access to First Nations data is important and First Nations must have access to data and information about themselves and their communities regardless of where it is currently held.</p>`
                }
            };

            if (type !== 'external') {
                const content = document.getElementById(`content-${docId}`);
                content.classList.add('show');
                content.innerHTML = type === 'tldr' ? texts[docId].tldr : texts[docId].full;
            }

            if (!docStatus[docId]) {
                docStatus[docId] = true;
                const row = document.getElementById(`ack-${docId}`);
                row.classList.add('unlocked');
                row.style.opacity = '1'; row.style.cursor = 'pointer';
                const lock = document.getElementById(`lock-${docId}`);
                if(lock) lock.style.display = 'none';
            }
        }

        function showAllTLDR() { unlockAck('doc-1', 'tldr'); unlockAck('doc-2', 'tldr'); unlockAck('doc-3', 'tldr'); }

        function toggleAck(docId) {
            if (!docStatus[docId]) return;
            docCheck[docId] = !docCheck[docId];
            const row = document.getElementById(`ack-${docId}`);
            row.classList.toggle('checked');
            const btn = document.getElementById('gate-btn');
            if (docCheck['doc-1'] && docCheck['doc-2'] && docCheck['doc-3']) {
                btn.disabled = false; btn.style.opacity = '1'; btn.style.cursor = 'pointer'; btn.style.background = 'var(--text-main)';
            } else {
                btn.disabled = true; btn.style.opacity = '0.3'; btn.style.cursor = 'not-allowed';
            }
        }

        function enterApp() {
            document.getElementById('ethics-screen').classList.add('hidden');
            document.getElementById('app-shell').classList.remove('hidden');
            loadScenario();
        }

        // --- GOV & GRAPH LOGIC ---
        function setGovMode(mode, el) {
            govState.mode = mode;
            document.querySelectorAll('.gov-mode-btn').forEach(b => b.classList.remove('active'));
            el.classList.add('active');
            showToast(`Gov Mode: ${mode.toUpperCase()}`);
        }

        function updateGovAdvisory(type) {
            const status = document.getElementById('gov-status-text');
            const tags = document.getElementById('gov-risk-tags');
            const s = scenarios[state.currentScenario];
            tags.innerHTML = '';
            const principleList = type === 'safe' ? govState.principles.safe : govState.principles.risk;
            principleList.forEach(p => { tags.innerHTML += `<span class="gov-tag">${p}</span>`; });

            if (govState.mode === 'adv') {
                status.innerHTML = `<strong>Advisory:</strong> Choice aligns with <span style="color:var(--brand)">${principleList[0]}</span>. Evaluating ${s.oecd_mapping}.`;
            } else if (govState.mode === 'rev') {
                status.innerHTML = `<i class="ph ph-warning" style="color:var(--danger)"></i> <strong>Review Required:</strong> Verify 'Strategic Intent' mitigates <span style="color:var(--danger)">${principleList[1]}</span> risks per OECD standards.`;
            } else {
                status.innerHTML = `<span style="color:var(--text-muted)">Observing decision flow...</span>`;
            }
        }

        function drawTrustGraph() {
            const canvas = document.getElementById('trust-graph');
            if(!canvas) return;
            const ctx = canvas.getContext('2d');
            const w = 80, h = 30;
            ctx.clearRect(0, 0, w, h);
            ctx.beginPath();
            ctx.strokeStyle = state.trust >= 80 ? '#2A7E4B' : (state.trust >= 50 ? '#EAB308' : '#C92A2A');
            ctx.lineWidth = 2;
            const data = state.trustHistory.slice(-10);
            const step = w / (data.length > 1 ? data.length - 1 : 1);
            data.forEach((val, i) => {
                const y = h - ((val / 100) * h);
                if (i === 0) ctx.moveTo(0, y);
                else ctx.lineTo(i * step, y);
            });
            ctx.stroke();
        }

        // --- DASHBOARD LOGIC ---
        function switchTab(id, el) {
            document.querySelectorAll('.tab-view').forEach(t => t.classList.remove('active'));
            document.getElementById('tab-' + id).classList.add('active');
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            el.classList.add('active');
        }

        function typeWriter(text, element) {
            return new Promise(resolve => {
                let i = 0;
                function type() {
                    if (i < text.length) {
                        element.innerHTML += text.charAt(i);
                        element.scrollTop = element.scrollHeight;
                        i++; setTimeout(type, 15);
                    } else resolve();
                }
                type();
            });
        }

        async function loadScenario() {
            const idx = document.getElementById('scenario-selector').value;
            state.currentScenario = idx;
            const s = scenarios[idx];
            document.getElementById('safe-label').innerText = s.safe_btn || "Ethical Action";
            document.getElementById('risk-label').innerText = s.risk_btn || "Risky Action";
            document.getElementById('safe-desc').innerText = s.ethical;
            document.getElementById('risk-desc').innerText = s.risk;
            document.getElementById('stakeholder-feed').innerHTML = `<div style="text-align:center; margin-top:60px; color:#ccc;">Awaiting Decision</div>`;
            document.getElementById('terminal-output').innerHTML = `<div style="border-bottom:1px solid #333; margin-bottom:10px; color:#666;">ETHOS OS v2.5.3 // GOVERNANCE ACTIVE</div>> INCOMING ALERT: ${s.title}\n> CONTEXT: ${s.desc}\n\n> Awaiting directive...<span class="cursor"></span>`;
            drawTrustGraph();
        }

        function initDecision(type) {
            state.pendingDecision = type;
            document.getElementById('reflection-modal').classList.remove('hidden');
            if (govState.mode !== 'obs') {
                document.getElementById('gov-copilot').style.display = 'flex';
                updateGovAdvisory(type);
            }
        }

        function closeModal() {
            document.getElementById('reflection-modal').classList.add('hidden');
            document.getElementById('ref-intent').value = "";
        }

        async function confirmDecision() {
            const intent = document.getElementById('ref-intent').value;
            const impact = document.getElementById('ref-impact').value;
            if(!intent) { alert("Please enter your strategic intent."); return; }
            closeModal();
            const type = state.pendingDecision;
            const s = scenarios[state.currentScenario];
            const isSafe = type === 'safe';

            document.getElementById('btn-safe').disabled = true;
            document.getElementById('btn-risk').disabled = true;

            const term = document.getElementById('terminal-output');
            term.innerHTML = term.innerHTML.replace('<span class="cursor"></span>', '');
            term.innerHTML += `\n> INPUT: [${type.toUpperCase()}]\n> INTENT: "${intent}"\n> PROCESSING...`;
            term.innerHTML += `\n<span style="color:var(--brand); font-weight:600;">[GOV_AUDIT] Framework: ${s.oecd_mapping} verified.</span>`;

            await new Promise(r => setTimeout(r, 800));

            const responseText = isSafe ? s.res_safe : s.res_risk;
            const resSpan = document.createElement('div');
            resSpan.style.marginTop = "16px"; resSpan.style.fontWeight = "600";
            resSpan.style.color = isSafe ? "var(--safe)" : "var(--danger)";
            term.appendChild(resSpan);
            await typeWriter(responseText, resSpan);
            term.innerHTML += `<span class="cursor"></span>`;

            if(isSafe) { 
                state.xp += 150; state.trust = Math.min(100, state.trust + 5); state.streak++; state.incidents = Math.max(0, state.incidents - 1); 
            } else { 
                state.xp += 10; state.trust = Math.max(0, state.trust - 25); state.streak = 0; state.incidents++; 
            }
            state.trustHistory.push(state.trust);
            state.history.push({ 
                scenario: s.title, type: type, action: isSafe ? s.ethical : s.risk, 
                intent: intent, impact_prediction: impact, reality: isSafe ? s.real_safe : s.real_risk,
                oecd: s.oecd_mapping,
                time: new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }) 
            });

            updateStats(); renderHistory(); generateAnalysis(); drawTrustGraph();
            setTimeout(() => { document.getElementById('gov-copilot').style.display = 'none'; }, 2000);

            const feed = document.getElementById('stakeholder-feed');
            feed.innerHTML = '';
            (isSafe ? s.stakeholders : s.stakeholders_bad).forEach(p => {
                feed.innerHTML += `<div class="sh-item"><div class="sh-emoji">${p.e}</div><div class="sh-content"><div class="sh-name">${p.n}</div><div class="sh-quote">"${p.t}"</div></div></div>`;
            });

            document.getElementById('btn-safe').disabled = false;
            document.getElementById('btn-risk').disabled = false;
        }

        // --- UI UTILS ---
        function updateStats() {
            document.getElementById('xp-display').innerText = state.xp.toLocaleString();
            document.getElementById('trust-display').innerText = state.trust + '%';
            document.getElementById('streak-display').innerText = state.streak;
            const stats = document.querySelectorAll('.stat-val');
            if(stats[3]) stats[3].innerText = state.incidents;
            
            if(state.xp >= 5000) state.level = "Chief Ethics Officer";
            else if(state.xp >= 3000) state.level = "Crisis Commander";
            else if(state.xp >= 2000) state.level = "Risk Architect";
            else if(state.xp >= 500) state.level = "Junior Analyst";
            document.getElementById('rank-display').innerText = state.level;

            checkUnlock(500, 'cert-1', 'lock-1', 'Junior Analyst');
            checkUnlock(2000, 'cert-2', 'lock-2', 'Risk Architect');
            checkUnlock(3000, 'cert-4', 'lock-4', 'Crisis Commander');
            checkUnlock(5000, 'cert-5', 'lock-5', 'Chief Ethics Officer');
        }

        function checkUnlock(th, certId, lockId, newTitle) {
            if (state.xp >= th) {
                const card = document.getElementById(certId);
                if (card && !card.classList.contains('unlocked')) {
                    card.classList.add('unlocked');
                    const lock = document.getElementById(lockId);
                    if(lock) lock.style.display = 'none';
                    if (newTitle) showToast(`Promoted to ${newTitle}`);
                }
            }
        }

        function generateAnalysis() {
            const total = state.history.length;
            if (total === 0) return;
            const safeCount = state.history.filter(h => h.type === 'safe').length;
            const ratio = safeCount / total;
            let summary = ratio >= 0.8 ? "<strong>Profile: The Guardian.</strong> Strict compliance focus." : "<strong>Profile: The Pragmatist.</strong> Balanced ethics and growth.";
            if(ratio < 0.5) summary = "<strong>Profile: The Cowboy.</strong> High liability exposure.";
            document.getElementById('analysis-content').innerHTML = `<p style="font-size:13px; line-height:1.6;">${summary}</p>`;
            const rMeter = document.getElementById('risk-meter');
            rMeter.innerText = ratio >= 0.5 ? "Low" : "CRITICAL";
            rMeter.style.color = ratio >= 0.5 ? "var(--safe)" : "var(--danger)";
        }

        function renderHistory() {
            const feed = document.getElementById('history-feed');
            feed.innerHTML = '';
            [...state.history].reverse().forEach(h => {
                const color = h.type === 'safe' ? 'var(--safe)' : 'var(--danger)';
                feed.innerHTML += `
                    <div style="padding:16px; border-bottom:1px solid var(--border);">
                        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px;">
                            <div style="font-size:12px; font-weight:700;">${h.scenario}</div>
                            <div style="font-size:11px; color:var(--text-muted);">${h.time}</div>
                        </div>
                        <div style="font-size:11px; color:var(--brand); font-weight:600; margin-bottom:4px;">Framework: ${h.oecd}</div>
                        <div style="font-size:12px; color:#444;">Action: ${h.action}</div>
                        <div style="font-size:11px; font-style:italic; color:${color}; margin-top:4px;">"${h.intent}"</div>
                        <div class="reality-box fade-in">
                            <div class="reality-title"><i class="ph-fill ph-globe-hemisphere-west"></i> Real Life Consequence</div>
                            ${h.reality}
                        </div>
                    </div>`;
            });
        }

        function resetSim() { if(confirm("Reset simulation?")) window.location.reload(); }
        function nukeEnv() { if(confirm("Decommission environment?")) window.location.reload(); }
        function downloadCert() { showToast("Certificate Downloaded (PDF)"); }
        function showToast(msg) { const t = document.getElementById('toast'); t.innerText = msg; t.classList.add('show'); setTimeout(() => t.classList.remove('show'), 3000); }
        function exportReport() { const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(state.history, null, 2)); const node = document.createElement('a'); node.setAttribute("href", dataStr); node.setAttribute("download", "ethos_audit_log.json"); document.body.appendChild(node); node.click(); node.remove(); }
    </script>
</body>
</html>